{% extends "base.html" %}

{% block content %}
<h1>Unreviewed Internal Transactions</h1>

<form method="POST" id="my-form">
    {% csrf_token %}

    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Retailer</th>
                <th>Account</th>
                <th>Amount</th>
                <th>Note</th>
                <th>Is Internal</th>
                <th>Requires Detail</th>
                <th>Reviewed</th>
                <th>Link</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transaction_list %}
            {% if transaction.is_internal %}
            <tr class="table-primary">
                {% else %}
            <tr>
                {% endif %}
                {% with print_flags=True ignore_category=True %}
                {% include 'transaction/transaction_cell.html' %}
                {% endwith %}
                {% if transaction.is_internal %}
                {% if transaction.related_transaction %}
                <td><a href="{% url 'money:transaction_detail' transaction.related_transaction.id %}">
                        {{ transaction.related_transaction.id }}</a></td>
                {% else %}
                <td><input type="number" id="input_{{ transaction.id }}" name="name_{{ transaction.id }}"></td>
                {% endif %}
                {% else %}
                <td>Not applicable</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary" id="id_submit">Update Link</button>
</form>

<div class="pagination">
    <span class="step-links">
        {% if internal_only %}
        {% if page_obj.has_previous %}
        <a href="?page=1&internal_only=True">&laquo; first</a>
        <a href="?page={{ page_obj.previous_page_number }}&internal_only=True">previous</a>
        {% endif %}

        <span class="current-page">
            Page {{ page_obj.number }} of {{ paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&internal_only=True">next</a>
        <a href="?page={{ paginator.num_pages }}&internal_only=True">last &raquo;</a>
        {% endif %}
        {% else %}
        {% if page_obj.has_previous %}
        <a href="?page=1">&laquo; first</a>
        <a href="?page={{ page_obj.previous_page_number }}">previous</a>
        {% endif %}

        <span class="current-page">
            Page {{ page_obj.number }} of {{ paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">next</a>
        <a href="?page={{ paginator.num_pages }}">last &raquo;</a>
        {% endif %}
        {% endif %}
    </span>
</div>

<script>
    document.getElementById('my-form').addEventListener('submit', function (event) {
        // Prevent the form from submitting normally
        event.preventDefault();

        // Get the form data
        var formData = new FormData(this);

        // Send the form data via AJAX using fetch
        fetch("{% url 'money:update_related_transaction' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.ok) {
                    // Handle the response
                    return response.text();
                } else {
                    // Handle errors
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error(error);
            });
    });

</script>

{% endblock %}